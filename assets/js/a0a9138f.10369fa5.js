"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4660],{3905:(e,n,r)=>{r.d(n,{Zo:()=>i,kt:()=>m});var t=r(7294);function s(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function o(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){s(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,t,s=function(e,n){if(null==e)return{};var r,t,s={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(s[r]=e[r]);return s}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var c=t.createContext({}),d=function(e){var n=t.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):o(o({},n),e)),r},i=function(e){var n=d(e.components);return t.createElement(c.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},p=t.forwardRef((function(e,n){var r=e.components,s=e.mdxType,a=e.originalType,c=e.parentName,i=l(e,["components","mdxType","originalType","parentName"]),p=d(r),m=s,g=p["".concat(c,".").concat(m)]||p[m]||u[m]||a;return r?t.createElement(g,o(o({ref:n},i),{},{components:r})):t.createElement(g,o({ref:n},i))}));function m(e,n){var r=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var a=r.length,o=new Array(a);o[0]=p;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l.mdxType="string"==typeof e?e:s,o[1]=l;for(var d=2;d<a;d++)o[d]=r[d];return t.createElement.apply(null,o)}return t.createElement.apply(null,r)}p.displayName="MDXCreateElement"},4444:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>d});var t=r(7462),s=(r(7294),r(3905));const a={sidebar_position:1,sidebar_class_name:"green"},o="Koa 2 \u6a21\u62df\u4e0b\u5355",l={unversionedId:"NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u6a21\u62df\u4e0b\u5355",id:"NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u6a21\u62df\u4e0b\u5355",title:"Koa 2 \u6a21\u62df\u4e0b\u5355",description:"\u521b\u5efa Models",source:"@site/docs/04-NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u6a21\u62df\u4e0b\u5355.md",sourceDirName:"04-NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355",slug:"/NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u6a21\u62df\u4e0b\u5355",permalink:"/m/docs/NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u6a21\u62df\u4e0b\u5355",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/04-NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u6a21\u62df\u4e0b\u5355.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,sidebar_class_name:"green"},sidebar:"tutorialSidebar",previous:{title:"Koa 2 \u6a21\u62df\u4e0b\u5355",permalink:"/m/docs/category/koa-2-\u6a21\u62df\u4e0b\u5355"},next:{title:"\u521b\u5efa\u5730\u5740 \u3001\u83b7\u53d6\u5730\u5740\u5217\u8868\u3001\u8be6\u60c5\u3001\u66f4\u65b0\u8def\u7531\\_\u526f\u672c",permalink:"/m/docs/NodeJs/Koa 2 \u6a21\u62df\u4e0b\u5355/\u521b\u5efa\u5730\u5740 \u3001\u83b7\u53d6\u5730\u5740\u5217\u8868\u3001\u8be6\u60c5\u3001\u66f4\u65b0\u8def\u7531"}},c={},d=[{value:"\u521b\u5efa Models",id:"\u521b\u5efa-models",level:3},{value:"\u6a21\u62df\u521b\u5efa\u7528\u6237",id:"\u6a21\u62df\u521b\u5efa\u7528\u6237",level:3},{value:"\u6ce8\u518c\u63a5\u53e3",id:"\u6ce8\u518c\u63a5\u53e3",level:3},{value:"\u7edf\u4e00\u5904\u7406\u7ed3\u679c\u4fe1\u606f",id:"\u7edf\u4e00\u5904\u7406\u7ed3\u679c\u4fe1\u606f",level:3},{value:"\u767b\u5f55\u63a5\u53e3",id:"\u767b\u5f55\u63a5\u53e3",level:3},{value:"\u521b\u5efa\u5730\u5740",id:"\u521b\u5efa\u5730\u5740",level:3},{value:"\u5546\u5e97\u3001\u5546\u54c1\u63a5\u53e3",id:"\u5546\u5e97\u5546\u54c1\u63a5\u53e3",level:2},{value:"\u8ba2\u5355\u63a5\u53e3",id:"\u8ba2\u5355\u63a5\u53e3",level:2}],i={toc:d};function u(e){let{components:n,...a}=e;return(0,s.kt)("wrapper",(0,t.Z)({},i,a,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"koa-2-\u6a21\u62df\u4e0b\u5355"},"Koa 2 \u6a21\u62df\u4e0b\u5355"),(0,s.kt)("h3",{id:"\u521b\u5efa-models"},"\u521b\u5efa Models"),(0,s.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5b9a\u4e49 Model\uff0c\u5148\u5b9a\u4e49 Schema\uff0c\u7136\u540e\u6839\u636e Schema \u901a\u8fc7 mongoose.model()\u751f\u6210 Model"),(0,s.kt)("p",null,"user Model"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'// \u5b9a\u4e49\u7528\u6237\u7684Model\nconst mongoose = require("../db/db");\nconst Schema = mongoose.Schema(\n  {\n    username: {\n      type: String,\n      require: true, // \u5fc5\u987b\n      unique: true, // \u552f\u4e00\u4e0d\u53ef\u91cd\u590d\n    },\n    password: String,\n  },\n  {\n    timestamps: true,\n  }\n);\n\nconst User = mongoose.model("user", Schema);\n\nmodule.exports = User;\n')),(0,s.kt)("p",null,"address Model"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const mongoose = require("../db/db");\nconst Schema = mongoose.Schema(\n  {\n    username: {\n      type: String,\n      require: true, // \u5fc5\u987b\n    },\n    city: String,\n    department: String,\n    houseNumber: String,\n    name: String,\n    phone: String,\n  },\n  {\n    timestamps: true,\n  }\n);\nconst Address = mongoose.model("address", Schema);\nmodule.exports = Address;\n')),(0,s.kt)("p",null,"\u5546\u5e97 model"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const Schema = mongoose.Schema(\n  {\n    name: String,\n    imgUrl: String,\n    sales: Number,\n    expressLimit: {\n      type: Number,\n      default: 0,\n    },\n    expressPrice: Number,\n    slogan: String,\n  },\n  {\n    timestamps: true,\n  }\n);\n\nconst Shop = mongoose.model("shop", Schema);\n\nmodule.exports = Shop;\n')),(0,s.kt)("p",null,"\u5546\u54c1 Model"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"const mongoose = require(\"../db/db\");\n\nconst Schema = mongoose.Schema(\n  {\n    shopId: {\n      type: String,\n      require: true,\n    },\n    name: String,\n    imgUrl: String,\n    sales: Number,\n    price: Number,\n    oldPrice: Number,\n    //   \u4fa7\u8fb9\u7684tabs \u89c4\u5b9a\u6b64\u5546\u54c1\u5c5e\u4e8e\u54ea\u4e2atab\n    tabs: [String], // ['all', 'kill']\n  },\n  {\n    timestamps: true,\n  }\n);\n\nconst Product = mongoose.model(\"product\", Schema);\n\nmodule.exports = Product;\n")),(0,s.kt)("h3",{id:"\u6a21\u62df\u521b\u5efa\u7528\u6237"},"\u6a21\u62df\u521b\u5efa\u7528\u6237"),(0,s.kt)("p",null,"\u5728 db \u76ee\u5f55\u4e0b\u65b0\u5efa test.sj \u6587\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const User = require("../../models/User");\n\n!(async () => {\n  // \u521b\u5efa\u4e00\u4e2a\u7528\u6237\n  //   await User.create({\n  //     username: "roc",\n  //     password: "123456",\n  //   });\n\n  //   \u5728\u521b\u5efa\u4e00\u4e2a\u7528\u6237\n  //   await User.create({\n  //     username: "peng",\n  //     password: "456",\n  //   });\n\n  const roc = await User.findOne({\n    username: "roc",\n    password: "123456",\n  });\n\n  console.log("\u67e5\u8be2\u7ed3\u679c", roc);\n})();\n')),(0,s.kt)("p",null,"User.create()\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7528\u6237\uff0cUser.findOne \u662f\u67e5\u627e\u7528\u6237\uff0c\u521b\u5efa\u548c\u67e5\u627e\u7ed3\u679c\u5982\u4e0b"),(0,s.kt)("p",null,"\u521b\u5efa\u7ed3\u679c"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(1447).Z,width:"1272",height:"1072"})),(0,s.kt)("p",null,"\u67e5\u627e\u7ed3\u679c"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(2618).Z,width:"744",height:"454"})),(0,s.kt)("h3",{id:"\u6ce8\u518c\u63a5\u53e3"},"\u6ce8\u518c\u63a5\u53e3"),(0,s.kt)("p",null,"\u9996\u5148\u5728",(0,s.kt)("inlineCode",{parentName:"p"},"src/controller"),"\u4e0b\u65b0\u5efa\u7528\u6237\u76f8\u5173\u7684\u64cd\u4f5c\u6587\u4ef6",(0,s.kt)("inlineCode",{parentName:"p"},"user.js")," ,\u5185\u5bb9\u5982\u4e0b"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const User = require("../models/User");\n/**\n *\u6ce8\u518c\n * @param {string} username \u7528\u6237\u540d\n * @param {string} password \u5bc6\u7801\n * @returns \u521b\u5efa\u7ed3\u679c\n */\nasync function register(username, password) {\n  const newUser = await User.create({\n    username,\n    password,\n  });\n  return newUser;\n}\n\nmodule.exports = {\n  register,\n};\n')),(0,s.kt)("p",null,"controller \u4e3b\u8981\u662f\u64cd\u4f5c\u6570\u636e\u5e93\uff0c\u90a3\u4e48\u5728\u54ea\u91cc\u8c03\u63a5\u53e3\u5462\uff0c\u662f\u5728",(0,s.kt)("inlineCode",{parentName:"p"},"src/routes/users.js")," ,\u5728\u8fd9\u91cc\u5b9a\u4e49\u6ce8\u518c\u767b\u5f55\u7b49\u63a5\u53e3\uff0c\u5148\u6765\u5199\u6ce8\u518c\u63a5\u53e3"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const router = require("koa-router")();\nconst { register } = require("../controller/user");\n\nrouter.prefix("/api/user"); // \u8def\u7531\u524d\u7f00\n\n// \u6ce8\u518c\nrouter.post("/register", async function (ctx, next) {\n  const { username, password } = ctx.request.body;\n  try {\n    const newUser = await register(username, password);\n    ctx.body = {\n      error: 0, // \u6210\u529f\n      data: newUser,\n    };\n  } catch (error) {\n    console.error(error);\n    ctx.body = {\n      error: 10001,\n      message: "\u521b\u5efa\u5931\u8d25- " + error.message,\n    };\n  }\n});\n')),(0,s.kt)("p",null,"\u5b8c\u6574\u6ce8\u518c\u5730\u5740\u4e3a ",(0,s.kt)("inlineCode",{parentName:"p"},"/api/user/register")," ,\u65b9\u6cd5\u4e3a post, \u5f53\u6ce8\u518c\u65f6\uff0c\u4f1a\u8c03\u7528 controller \u4e2d\u7684 register \u65b9\u6cd5\uff0c\u4f1a\u901a\u8fc7 User.create()\u65b9\u6cd5\u53bb\u521b\u5efa\u8fd9\u4e2a\u7528\u6237\uff0c \u8fd4\u56de\u521b\u5efa\u7ed3\u679c\uff0c\u7136\u540e await \u62ff\u5230\u6ce8\u518c\u7ed3\u679c\uff0c\u901a\u8fc7 ctx.body \u8fd4\u56de\u7ed9\u524d\u7aef\u3002"),(0,s.kt)("p",null,"\u95ee\u9898\uff1a\u8fd9\u6837\u8fd4\u56de\u6210\u529f\u6216\u9519\u8bef\u4fe1\u606f\u4f1a\u5f88\u7e41\u7410\uff0c\u6bcf\u6b21\u90fd\u5f97\u624b\u52a8\u5199\uff0c\u4ee5\u540e\u4e5f\u4e0d\u597d\u7ef4\u62a4\uff0c\u6240\u4ee5\u5148\u5b9a\u4e49\u597d\u6210\u529f\u548c\u5931\u8d25\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u7edf\u4e00\u5904\u7406"),(0,s.kt)("h3",{id:"\u7edf\u4e00\u5904\u7406\u7ed3\u679c\u4fe1\u606f"},"\u7edf\u4e00\u5904\u7406\u7ed3\u679c\u4fe1\u606f"),(0,s.kt)("p",null,"\u5728 ",(0,s.kt)("inlineCode",{parentName:"p"},"src/res-models")," \u4e0b\u65b0\u5efa ",(0,s.kt)("inlineCode",{parentName:"p"},"SuccessModel.js")," \u6587\u4ef6\u548c ",(0,s.kt)("inlineCode",{parentName:"p"},"ErrorModel.js")," \u6587\u4ef6\uff0c\u5206\u522b\u5982\u4e0b"),(0,s.kt)("p",null,"\u6210\u529f\u7684 class"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"class SuccessModel {\n  constructor(data) {\n    this.errno = 0;\n    if (data !== null) this.data = data;\n  }\n}\n\nmodule.exports = SuccessModel;\n")),(0,s.kt)("p",null,"\u5931\u8d25\u7684 class"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'class ErrorModel {\n  constructor(error = -1, message = "error") {\n    this.errno = error;\n    this.message = message;\n  }\n}\n\nmodule.exports = ErrorModel;\n')),(0,s.kt)("p",null,"\u6210\u529f\u53ef\u4ee5\u9009\u62e9\u662f\u5426\u8fd4\u56de data\uff0c\u5931\u8d25\u4f1a\u8fd4\u56de error \u548c message"),(0,s.kt)("p",null,"\u6709\u4e86\u8fd9\u4e24\u4e2a\u7c7b\uff0c\u5c31\u53ef\u4ee5\u5b8c\u5584\u4e0b\u4e4b\u524d\u7684\u6ce8\u518c\u63a5\u53e3\u4e86"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const { ErrorModel, SuccessModel } = require("../res-model/index");\n\nrouter.post("/register", async function (ctx, next) {\n  const { username, password } = ctx.request.body;\n  try {\n    const newUser = await register(username, password);\n    ctx.body = new SuccessModel(newUser);\n  } catch (error) {\n    console.error(error);\n    ctx.body = new ErrorModel(10001, "\u6ce8\u518c\u5931\u8d25- " + error.message);\n  }\n});\n')),(0,s.kt)("p",null,"\u542f\u52a8\u7a0b\u5e8f\uff0c\u6253\u5f00 postman \u8fdb\u884c\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5982\u4e0b"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(5729).Z,width:"1804",height:"1276"})),(0,s.kt)("p",null,"\u901a\u8fc7 post \u4f20\u7ed9 koa json \u7684\u6570\u636e\uff0c\u4f1a\u8fd4\u56de\u6ce8\u518c\u540e\u7684\u4fe1\u606f\uff0c\u5982\u679c\u540c\u6837\u7684\u4fe1\u606f\uff0c\u518d\u6b21\u6ce8\u518c\u5c31\u4f1a\u662f\u5982\u4e0b\u7ed3\u679c\u4e86\uff0c\u63d0\u793a\u6ce8\u518c\u5931\u8d25"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(7794).Z,width:"1798",height:"394"})),(0,s.kt)("h3",{id:"\u767b\u5f55\u63a5\u53e3"},"\u767b\u5f55\u63a5\u53e3"),(0,s.kt)("p",null,"\u6709\u4e86\u4e0a\u9762\u7684\u94fa\u57ab\uff0c\u767b\u5f55\u5c31\u5bb9\u6613\u591a\u4e86 \uff0c \u6570\u636e\u5e93\u76f8\u5173\u7684\u653e\u5728 controller/user.js \u4e2d"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"/**\n *\u767b\u5f55\n * @param {string} username \u7528\u6237\u540d\n * @param {string} password \u5bc6\u7801\n * @returns \u67e5\u8be2\u7ed3\u679c\n */\nasync function login(username, password) {\n  const user = await User.findOne({\n    username,\n    password,\n  });\n  return user != null ? true : false;\n}\n")),(0,s.kt)("p",null,"\u63a5\u53e3\u903b\u8f91\u5199\u5728\u548c\u6ce8\u518c\u4e00\u4e2a\u6587\u4ef6\u91cc ",(0,s.kt)("inlineCode",{parentName:"p"},"src/routes/users.js")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'// \u767b\u5f55\nrouter.post("/login", async function (ctx, next) {\n  const { username, password } = ctx.request.body;\n  console.log("** --- result --- **", username); // wsp-log\n  const result = await login(username, password);\n  if (result) {\n    ctx.session.userInfo = { username };\n    ctx.body = new SuccessModel();\n  } else {\n    ctx.body = new ErrorModel(10002, "\u767b\u5f55\u5931\u8d25- ");\n  }\n});\n')),(0,s.kt)("p",null,"\u4e0b\u9762\u5206\u522b\u6d4b\u8bd5\u767b\u5f55\u6210\u529f\u548c\u5931\u8d25\u7684\u7ed3\u679c"),(0,s.kt)("p",null,"\u6210\u529f"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(5896).Z,width:"1326",height:"848"})),(0,s.kt)("p",null,"\u5931\u8d25"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(7231).Z,width:"1390",height:"890"})),(0,s.kt)("p",null,"\u5931\u8d25\u7684\u662f username \u591a\u4e86\u4e2a 1\uff0c\u6240\u4ee5\u4f1a\u8fd4\u56de\u767b\u5f55\u5931\u8d25"),(0,s.kt)("h3",{id:"\u521b\u5efa\u5730\u5740"},"\u521b\u5efa\u5730\u5740"),(0,s.kt)("p",null,"\u521b\u5efa\u5730\u5740\u9700\u8981\u767b\u5f55\u4eba\u5728\u767b\u5f55\u72b6\u6001\uff0c\u6240\u4ee5\u9700\u8981\u6821\u9a8c\u767b\u5f55\u72b6\u6001\uff0c\u7531\u4e8e\u767b\u5f55\u540e\u4f1a\u8fd4\u56de\u7ed9\u524d\u7aef\u7528\u6237\u4fe1\u606f ",(0,s.kt)("inlineCode",{parentName:"p"},"ctx.session.userInfo = { username };")," \uff0c\u6240\u4ee5\u521b\u5efa\u5730\u5740\u53ef\u4ee5\u62ff\u5230\u7528\u6237\u4fe1\u606f\u3002"),(0,s.kt)("p",null,"\u5730\u5740\u7684\u903b\u8f91"),(0,s.kt)("p",null,"\u5730\u5740 controller"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const Address = require("../models/Address");\n\n/**\n * \u521b\u5efa\u5730\u5740\n * @param {string} username \u7528\u6237\u540d\n * @param {Object} data \u5730\u5740\u4fe1\u606f\n * @returns \u65b0\u7684\u5730\u5740\n */\nasync function createAddress(username, data) {\n  const address = await Address.create({\n    username,\n    ...data,\n  });\n  return address;\n}\n')),(0,s.kt)("p",null,"\u521b\u5efa\u5730\u5740 api"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'router.prefix("/api/user/address");\n\n// \u521b\u5efa\u6536\u8d27\u5730\u5740 loginCheck \u662f\u767b\u5f55\u6821\u9a8c \u53ea\u6709\u767b\u5f55\u4e86\u624d\u53ef\u4ee5\u521b\u5efa\nrouter.post("/", loginCheck, async (ctx, next) => {\n  const userInfo = ctx.session.userInfo;\n  const data = ctx.request.body;\n\n  try {\n    const newAddress = await createAddress(userInfo.username, data);\n    ctx.body = new SuccessModel(newAddress);\n  } catch (error) {\n    console.error(error);\n    ctx.body = new ErrorModel(10003, "\u521b\u5efa\u5730\u5740\u5931\u8d25");\n  }\n});\n')),(0,s.kt)("p",null,"\u53ef\u4ee5\u53d1\u73b0\uff0cpost \u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f loginCheck\uff0c\u7528\u6765\u505a\u767b\u5f55\u6821\u9a8c\uff0c\u4ed6\u662f\u4e00\u4e2a\u4e2d\u95f4\u4ef6 \u5728",(0,s.kt)("inlineCode",{parentName:"p"},"middleware/logincheck.js")," \uff0c\u5185\u5bb9\u5982\u4e0b"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'/**\n * \u767b\u5f55\u9a8c\u8bc1\u4e2d\u95f4\u4ef6\n */\nconst { ErrorModel } = require("../res-model/index");\nmodule.exports = async (ctx, next) => {\n  const session = ctx.session;\n  if (session && session.userInfo) {\n    await next();\n    return;\n  } else {\n    ctx.body = new ErrorModel(10003, "session\u4e0d\u5b58\u5728");\n  }\n};\n')),(0,s.kt)("p",null,"\u5982\u679c\u6ca1\u6709 session \u4fe1\u606f\uff0c\u5c31\u4f1a\u8fd4\u56de\u767b\u5f55\u4e0d\u5b58\u5728"),(0,s.kt)("p",null,"\u4ee5\u4e0a\u5c31\u662f\u521b\u5efa\u5730\u5740\u7684\u6d41\u7a0b\uff0c\u903b\u8f91\u5199\u5b8c\uff0c\u522b\u5fd8\u4e86\u5728\u5165\u53e3\u6587\u4ef6 app.js \u4e2d\u5f15\u5165\uff0c\u5e76\u6ce8\u518c\u8def\u7531\u4fe1\u606f"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'const address = require("./routes/address");\n\napp.use(address.routes(), address.allowedMethods());\n')),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.wolai.com/wy7RoaHvhaa6DfS4GGNJXD",title:"\u521b\u5efa\u5730\u5740 \u3001\u83b7\u53d6\u5730\u5740\u5217\u8868\u3001\u8be6\u60c5\u3001\u66f4\u65b0\u8def\u7531_\u526f\u672c"},"\u521b\u5efa\u5730\u5740 \u3001\u83b7\u53d6\u5730\u5740\u5217\u8868\u3001\u8be6\u60c5\u3001\u66f4\u65b0\u8def\u7531","_","\u526f\u672c")),(0,s.kt)("h2",{id:"\u5546\u5e97\u5546\u54c1\u63a5\u53e3"},"\u5546\u5e97\u3001\u5546\u54c1\u63a5\u53e3"),(0,s.kt)("p",null,"\u540c\u4e0a\uff0c\u57fa\u672c\u903b\u8f91\u90fd\u5dee\u4e0d\u591a"),(0,s.kt)("h2",{id:"\u8ba2\u5355\u63a5\u53e3"},"\u8ba2\u5355\u63a5\u53e3"),(0,s.kt)("p",null,"\u7531\u4e8e\u8ba2\u5355\u4fe1\u606f\u5b58\u7684\u662f\u5f53\u524d\u4e0b\u5355\u65f6\u95f4\u7684\u5546\u54c1\u4fe1\u606f\uff0c\u5373\u4f7f\u4e4b\u540e\u5546\u54c1\u4fe1\u606f\u53d1\u751f\u53d8\u52a8\uff0c\u4e5f\u4e0d\u5f71\u54cd\u8ba2\u5355\u5185\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u8ba2\u5355\u5185\u4f1a\u5b58\u6709\u5f53\u524d\u65f6\u523b\u7684\u5546\u54c1\u4fe1\u606f\uff0c\u5e76\u4e0d\u5355\u5355\u53ea\u662f\u4e00\u4e2a\u5546\u54c1 id"),(0,s.kt)("p",null,"controller/order.js"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'/**\n * \u8ba2\u5355 controller\n */\n\nconst Order = require("../models/Order");\nconst Address = require("../models/Address");\nconst Product = require("../models/Product");\n\n/**\n * \u521b\u5efa\u8ba2\u5355\n * @param {string} username \u7528\u6237\u540d\n * @param {Object} data \u8ba2\u5355\u4fe1\u606f\n */\nasync function createOrder(username, data) {\n  const {\n    addressId,\n    shopId,\n    shopName,\n    isCanceled = false,\n    products = [],\n  } = data;\n  //   \u6839\u636e addressId \u62ff\u5230\u5730\u5740\u4fe1\u606f\n  const address = await Address.findById(addressId);\n  // \u83b7\u53d6\u5546\u54c1\u5217\u8868\n  const pids = products.map((i) => i.id);\n  let producList = await Product.find({\n    shopId,\n    _id: { $in: pids },\n  });\n\n  //   \u62fc\u63a5\u5546\u54c1\u8d2d\u4e70\u6570\u91cf\n  const productWithSales = producList.map((item) => {\n    const current = products.find((i) => i.id === item.id);\n    if (!current) throw new Error(`\u672a\u627e\u5230\u8be5\u5546\u54c1 - ${item.name}`);\n    item.orderSales = current.num;\n    return {\n      product: item,\n      orderSales: current.num,\n    };\n  });\n\n  //  \u521b\u5efa\u8ba2\u5355\n  const newOrder = await Order.create({\n    username,\n    shopName,\n    shopId,\n    isCanceled,\n    address,\n    products: productWithSales,\n  });\n  return newOrder;\n}\n\nmodule.exports = {\n  createOrder,\n};\n')),(0,s.kt)("p",null,"routes/order.js"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},'/**\n * \u8ba2\u5355 \u76f8\u5173\n */\n\nconst router = require("koa-router")();\nconst { createOrder } = require("../controller/order");\nconst loginCheck = require("../middleware/loginCheck");\nconst { ErrorModel, SuccessModel } = require("../res-model/index");\n\nrouter.prefix("/api/order");\n\n// \u521b\u5efa\u8ba2\u5355\nrouter.post("/", loginCheck, async (ctx, next) => {\n  const userInfo = ctx.session.userInfo;\n  const { username } = userInfo;\n\n  //   \u83b7\u53d6\u8ba2\u5355\u6570\u636e\n  const data = ctx.request.body;\n\n  //   \u521b\u5efa\u8ba2\u5355\n  try {\n    const result = await createOrder(username, data);\n    ctx.body = new SuccessModel(result);\n  } catch (error) {\n    ctx.body = new ErrorModel(10005, "\u521b\u5efa\u8ba2\u5355\u5931\u8d25");\n  }\n});\n\n// \u83b7\u53d6\u8ba2\u5355\u5217\u8868\n\nmodule.exports = router;\n')),(0,s.kt)("p",null,"\u8fd9\u6837\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7 postman \u6a21\u62df\u4e0b\u5355\u4e86"),(0,s.kt)("p",null,(0,s.kt)("img",{src:r(769).Z,width:"1948",height:"1378"})))}u.isMDXComponent=!0},769:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_5nA4lbZnQj-9c8b7c06011c0098246261d47acff55e.png"},5729:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_G45z3qY4it-bf4146c8dd5e3d3c6f20ea8f6b691f85.png"},1447:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_Yai8q3GS_J-4ea4ec6bf85be7d0656b631bcb49354c.png"},7231:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_dXKw8eXmP2-637d070cfc11e180dfb362a7ea5c8014.png"},7794:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_g3nrx1sLYh-7a3b2bc4711c4b4f79a5551cb24ac11f.png"},5896:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_lMLi3MaoEn-0b6217e954accc0692fce8348c1d1d33.png"},2618:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/image_pfIGqZr8kV-7271b933ef102c1d688f3619eaee375b.png"}}]);